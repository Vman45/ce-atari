<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
        <title>CosmosEx download page</title>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.light.css">
        <script type="text/javascript" src="js/modernizr.custom.50426.js"></script>

        <script type="text/javascript"> 
            var version="180509";
            document.write('<script type="text/javascript" src=js/jquery.js?'+version+'><\/script>');
        	document.write('<script type="text/javascript" src=js/floppy.js?'+version+'><\/script>');
            document.write('<link rel="stylesheet" type="text/css" href="css/style.css?'+version+'">');
        </script>

<script type="text/javascript">

    var inList = [];        // image list of games / software (e.g. A001.zip, A002.zip, ...)
    var gotList = [];       // list of files we already have downloaded
    var input_lists = [];   // contains list of list names - e.g. automation games, dbug games, ...

// this function takes the input csv with available online files and parses it into array of objects
function parseInputCsv(inputCsv)
{
    var items = [];

    var lines = inputCsv.split('\n');       // split whole file into lines
    for(var i=0; i<lines.length; i++) {     // go through all lines
        var item = new Object();
        var cols = lines[i].split(',');     // split single line into columns

        if(cols.length < 3) {               // if it doesn't contain at least one content, skip it
            continue;
        }

        item.url = cols[0];                     // col 0 is URL for download
        item.file = item.url.split('/').pop();  // get only file name
        item.crc = cols[1];                     // col 1 is CRC
        item.content = cols.slice(2);           // remaining cols are content of the file

        items.push(item);
    }

    return items;
}

function getHaveLists()
{
    // get list of games lists we can look through
    $.ajax({
        type: 'GET',
        url: '/api/v1/download/havelists',
        success: function(data){
            input_lists = data.havelists;
            fillInputListSelect()
        }
    })
}

function getHaveFiles()
{
    // get list of files we already have downloaded
    $.ajax({
        type: 'GET',
        url: '/api/v1/download/havefiles',
        success: function(data){
            // data.havefiles is a list of files we have
            gotList = data.havefiles;
        }
    })
}

function getInputCsv(list_filename)
{
    // get list of available online files 
    $.ajax({
        type: 'GET',
        url: '/api/v1/download/imagelist',
        success: function(data){
            inList = parseInputCsv(data.imagelist);             // parse it
            document.getElementById('search_input').value = ""; // clear the search string

            // refresh the shown list on screen
            onDelayedSearchStringChanged();
        }
    })
}

function insertStringAtPos(largeString, index, smallString)
{
    return largeString.substr(0, index) + smallString + largeString.substr(index);
}

function generateHtmlIcon(imgSrc)
{
    var icon = "<img width='32' height='32' src='";
    icon = icon.concat(imgSrc);
    icon = icon.concat("'>");
    return icon;
}

// generate one row from this matching item
function generateSearchResultRow(matchingItem, whatWeHaveList, searchString)
{
    // search string to lower case
    searchString = searchString.toLowerCase();

    // find out if the item is already downloaded
    var isDownloaded = false;
    for(var i=0; i<whatWeHaveList.length; i++) {
        if(whatWeHaveList[i].toLowerCase() == matchingItem.file.toLowerCase()) {
            isDownloaded = true;
            break;
        }
    }

    // use right image for showing download / is downloaded
    var downloadIcon = "";          // download action / is downloaded notification
    var insertIcons = "";           // nothing / insert into slot

    if(isDownloaded) {              // if file is downloaded
        downloadIcon = generateHtmlIcon("./icon_is_downloaded.png");

        for(var i=1; i<4; i++) {    // insert into slot 1, 2, 3
            var imagePath = "./icon_insert_".concat(i.toString(), ".png");
            insertIcons = insertIcons.concat(generateHtmlIcon(imagePath));
        }
    } else {                        // if file is not downloaded yet
        downloadIcon = generateHtmlIcon("./icon_download.png");

        for(var i=0; i<3; i++) {    // just 3 empty placeholders
            insertIcons = insertIcons.concat(generateHtmlIcon("./icon_insert_empty.png"));
        }
    }

    // create a string containing download + insert operations if possible
    var imageOps = downloadIcon.concat(insertIcons);

    // create string out of image content array
    content = matchingItem.content.join(", ");

    if(searchString.length > 0) {       // if the searchstring was supplied
        contentLC = content.toLowerCase();
        start = contentLC.indexOf(searchString);

        if(start != -1) {               // if the searchstring was found in the content
            end = start + searchString.length;
            content = insertStringAtPos(content, end, "</font></b>");
            content = insertStringAtPos(content, start, "<b><font color='#008000' style='text-decoration: underline;'>");
        }
    }

    // generate html table row
    var row = "<tr><td>";
    row = row.concat(matchingItem.file);
    row = row.concat("</td><td>");
    row = row.concat(imageOps);
    row = row.concat("</td><td>");
    row = row.concat(content);
    row = row.concat("</td></tr>");
    return row;
}

// go through the input list, find matching items, generate one page of results table 
function generateSearchResultsTable(inputList, whatWeHaveList, searchString, itemsPerPage, pageNumber)
{
    var resultsTable = "<table border=1 cellspacing=0 cellpadding=5>";

    searchString = searchString.toLowerCase();     // search string to lower case
    var matchingItemNumber = 0;                                     // number of current matching imte
    var matchingItemNumberMin = itemsPerPage * (pageNumber    );    // with respect to page number - at which matching item number should we START outputting items?
    var matchingItemNumberMax = itemsPerPage * (pageNumber + 1);    // with respect to page number - at which matching item number should we STOP  outputting items?

    for(var i=0; i<inputList.length; i++) {         // go through input list
        var item = inputList[i];

        var matching = false;

        if(searchString.length < 1) {               // no search string? everything matches
            matching = true;
        } else {                                    // search string provided? try to look for it
            for(var c=0; c<item.content.length; c++) {                          // go through all the content in that item
                if(item.content[c].toLowerCase().indexOf(searchString) != -1) { // if search string was found in the content
                    matching = true;
                    break;
                }
            }
        }

        // if the search string didn't match any of the content, skip the rest
        if(!matching) {
            continue;
        }

        // if the matching item fits to the right page, output it
        if(matchingItemNumber >= matchingItemNumberMin && matchingItemNumber < matchingItemNumberMax) {
            resultRow = generateSearchResultRow(item, whatWeHaveList, searchString);        // generate one row from this matching item
            resultsTable = resultsTable.concat(resultRow);
        }

        matchingItemNumber++;
    }

    // calculate total number to pages based on how many items were matching
    var totalPages = Math.ceil(matchingItemNumber / itemsPerPage);

    // nothing found?
    if(matchingItemNumber == 0) {
        resultRow = "<tr><td>nothing matches your search input</td></tr>";
        resultsTable = resultsTable.concat(resultRow);
    }

    resultsTable = resultsTable.concat("</table>");
    return resultsTable;    // return the results table
}

function onSearchStringChanged()
{
    // read search string
    var searchString = document.getElementById('search_input').value;

    // search the input
    var searchList = generateSearchResultsTable(inList, gotList, searchString, 15, 0);
    
    // output the results to page
    var results = document.getElementById('search_results');
    results.innerHTML = searchList;
}

function onDelayedSearchStringChanged()
{
    setTimeout(function(){ onSearchStringChanged(); }, 100);
}

function fillInputListSelect()
{
    var select = document.getElementById('input_list_name');
    select.innerHTML = "";                      // clear the list

    for (var i=0; i<input_lists.length; i++) {          // go through individual lists
        var option = document.createElement('option');
        option.innerHTML = input_lists[i].list_name_humanreadable;
        option.value = input_lists[i].list_filename;    // filename as list name
        option.selected = (i == 0);                     // select 0th option
        select.append(option);
    }
}

function onInputListChanged()
{
    var selected = document.getElementById('input_list_name').value;

    for (var i=0; i<input_lists.length; i++) {          // go through individual lists
        if(input_lists[i].list_filename == selected) {  // if found the list
            getInputCsv(input_lists[i].list_filename);  // get it from device
            break;
        }
    }
}

$(document).ready(function(){
   
    getHaveLists();     // get list of lists of games we have available
    getHaveFiles();     // get list of files we already have downloaded

    var select = document.getElementById('input_list_name');
    select.onchange = function(){ onInputListChanged(); };

    // add handler to search string change
    var search_input = document.getElementById('search_input')
    search_input.onchange = function(){ onDelayedSearchStringChanged(); };
    search_input.onkeydown = function(){ onDelayedSearchStringChanged(); };
    search_input.onkeypress = function(){ onDelayedSearchStringChanged(); };

    onInputListChanged();    
    onDelayedSearchStringChanged();
});

        </script>     
  </head>
  <body>
    <div class="container">
        <div class="row">
            <div class="span10">
                <ul class="nav nav-pills">
                    <li><a href="/?v=6">Home</a></li>
                    <li><a href="http://joo.kie.sk/?page_id=415">Manual</a></li>
                    <li><a href="/floppy.html?v=6">Floppy</a></li>
                    <li class="active"><a href="/download.html?v=6">Download</a></li>
                    <li><a href="/remote.html?v=6">Remote</a></li>
                    <li><a href="/screenshots.html?v=6">Screenshots</a></li>
                    <li><a href="/config.html?v=6">Config</a></li>
                    <li><a href="/app/status/?v=6">Status</a></li>
                </ul>
        <h3>Download games and software</h3>
        <p>Search and download things you want to play and use.</p>
        
    <!-- ---------------------------- -->
    <table border=1 cellspacing=0 cellpadding=5>
      <tr><td>Select list: </td><td> <select id="input_list_name"></select> </td></tr>
      <tr><td>Search:      </td><td> <input type="text" id="search_input">  </td></tr>
      <tr><td colspan=2><p id='search_results'></p> </td></tr>
    </table>        
 
  </body>
</html>

