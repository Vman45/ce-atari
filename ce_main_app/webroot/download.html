<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
        <title>CosmosEx download page</title>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.light.css">
        <script type="text/javascript" src="js/modernizr.custom.50426.js"></script>
        <script type="text/javascript" src="js/jquery.js?180509"> </script>
        <script type="text/javascript" src="js/floppy.js?180509"> </script>
        <link rel="stylesheet" type="text/css" href="css/style.css?180509">

<script type="text/javascript">

    var imageList = [];        // image list of games / software (e.g. A001.zip, A002.zip, ...)
    var totalPages = 0;
    var currentPage = 0;

function getSearchResults(searchString)
{
    url = '/api/v1/download/imagelist'; // base url

    if(searchString.length > 0) {       // some search string was specified?
        url = url + "?search=" + searchString;
    }

    // get list of available online files 
    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: function(data){
            // retrieve data from response
            totalPages = data.totalPages;
            currentPage = data.currentPate;
            imageList = data.imageList;
			
            // refresh the shown list on screen
            generateSearchResultsTable();
        },
        error: function (xhr) {
            console.log("Error: " + xhr.statusText);
        },
    })
}

function insertStringAtPos(largeString, index, smallString)
{
    return largeString.substr(0, index) + smallString + largeString.substr(index);
}

var IconType = {
  DOWNLOAD: 1,
  INSERT: 2,
  DUMMY: 3
};

function onInsert(imageName, slotNo)
{
    url = "/api/v1/download/insert?image=" + imageName + "&slot=" + slotNo;

    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: function(data){
            console.log("Insert Success");
        },
        error: function (xhr) {
            console.log("Insert Error: " + xhr.statusText);
        }
    })
}

function onDownload(imageName)
{
    url = "/api/v1/download/download?image=" + imageName;

    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: function(data){
            console.log("Download Success");
        },
        error: function (xhr) {
            console.log("Download Error: " + xhr.statusText);
        }
    })
}

function generateHtmlIcon(imgSrc, iconType, slotNo, imageName)
{
    var func = "";
    if(iconType == IconType.INSERT) {
        func = "onInsert('" + imageName + "', " + slotNo + ");";
    }

    if(iconType == IconType.DOWNLOAD) {
        func = "onDownload('" + imageName + "');";
    }

    var icon = "<img width='32' height='32' src='" + imgSrc + "' onclick=\"" + func + "\">";
    return icon;
}

// generate one row from this matching item
function generateSearchResultRow(item, searchString)
{
    // use right image for showing download / is downloaded
    var downloadIcon = "";          // download action / is downloaded notification
    var insertIcons = "";           // nothing / insert into slot

    if(item.haveIt) {               // if file is downloaded
        downloadIcon = generateHtmlIcon("img/icon_is_downloaded.png", IconType.DUMMY, 0, "");

        for(var i=1; i<4; i++) {    // insert into slot 1, 2, 3
            var imagePath = "img/icon_insert_".concat(i.toString(), ".png");
            insertIcons = insertIcons.concat(generateHtmlIcon(imagePath, IconType.INSERT, i-1, item.imageName));
        }
    } else {                        // if file is not downloaded yet
        downloadIcon = generateHtmlIcon("img/icon_download.png", IconType.DOWNLOAD, 0, item.imageName);

        for(var i=0; i<3; i++) {    // just 3 empty placeholders
            insertIcons = insertIcons.concat(generateHtmlIcon("img/icon_insert_empty.png", IconType.DUMMY, 0, ""));
        }
    }

    // create a string containing download + insert operations if possible
    var imageOps = downloadIcon.concat(insertIcons);

    content = item.content;             // modified content with possible highlighting

    if(searchString.length > 0) {       // if the searchstring was supplied
        contentLC = content.toLowerCase();
        start = contentLC.indexOf(searchString);

        if(start != -1) {               // if the searchstring was found in the content
            end = start + searchString.length;
            content = insertStringAtPos(content, end, "</font></b>");
            content = insertStringAtPos(content, start, "<b><font color='#008000' style='text-decoration: underline;'>");
        }
    }

    // generate html table row
    var row = "<tr><td>";
    row = row.concat(item.imageName);
    row = row.concat("</td><td>");
    row = row.concat(imageOps);
    row = row.concat("</td><td>");
    row = row.concat(content);
    row = row.concat("</td></tr>");
    return row;
}

// render the image list on screen 
function generateSearchResultsTable()
{
    var resultsTable = "<table border=1 cellspacing=0 cellpadding=5>";

    var searchString = document.getElementById('search_input').value;   // get search string
    searchString = searchString.toLowerCase();     // search string to lower case

    // nothing found?
    if(totalPages == 0) {
        resultRow = "<tr><td>nothing matches your search input</td></tr>";
        resultsTable = resultsTable.concat(resultRow);
    } else {
        for(var i=0; i<imageList.length; i++) {         // go through input list
            var item = imageList[i];

            // if the matching item fits to the right page, output it
            resultRow = generateSearchResultRow(item, searchString);        // generate one row from this matching item
            resultsTable = resultsTable.concat(resultRow);
        }
    }

    resultsTable = resultsTable.concat("</table>");

    var results = document.getElementById('search_results');    // find table
    results.innerHTML = resultsTable;                           // set content of the results table    
}

function onSearchStringChanged()
{
    // read search string
    var searchString = document.getElementById('search_input').value;   // get search string
    getSearchResults(searchString);     // get list of files after applying search string
}

function onDelayedSearchStringChanged()
{
    setTimeout(function(){ onSearchStringChanged(); }, 100);
}

$(document).ready(function(){
    getSearchResults(""); // get list of files

    // add handler to search string change
    var search_input = document.getElementById('search_input')
    search_input.onchange = function(){ onDelayedSearchStringChanged(); };
    search_input.onkeydown = function(){ onDelayedSearchStringChanged(); };
    search_input.onkeypress = function(){ onDelayedSearchStringChanged(); };
});

        </script>     
  </head>
  <body>
    <div class="container">
        <div class="row">
            <div class="span10">
                <ul class="nav nav-pills">
                    <li><a href="/?v=6">Home</a></li>
                    <li><a href="http://joo.kie.sk/?page_id=415">Manual</a></li>
                    <li><a href="/floppy.html?v=6">Floppy</a></li>
                    <li class="active"><a href="/download.html?v=6">Download</a></li>
                    <li><a href="/remote.html?v=6">Remote</a></li>
                    <li><a href="/screenshots.html?v=6">Screenshots</a></li>
                    <li><a href="/config.html?v=6">Config</a></li>
                    <li><a href="/app/status/?v=6">Status</a></li>
                </ul>
        <h3>Download games and software</h3>
        <p>Search and download things you want to play and use.</p>
        
    <!-- ---------------------------- -->
    <table border=1 cellspacing=0 cellpadding=5>
      <tr><td>Search:      </td><td> <input type="text" id="search_input">  </td></tr>
      <tr><td colspan=2><p id='search_results'></p> </td></tr>
    </table>        
 
  </body>
</html>

